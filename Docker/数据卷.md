# 管理App的数据

三种方式：

- Volumes
- Bind mounts
- tmpfs mounts

## `Volumes` 的使用场景

- 在多个运行的容器间共享数据。数据卷的生命周期超过容器的生命周期，并且会在容器第一次挂载时创建。多个容器可以挂载同一个数据卷，以`读写`或者`只读`模式。数据卷只有显示删除时，才会被销毁。
- 当主机不保证有固定的目录或者文件结构时，数据卷可以帮助主机的配置文件与容器运行时的解耦。
- 需要将容器数据存储到远端主机或者云上，而不是本地。
- 对主机数据的备份、还原或者迁移到另一台主机，数据卷是一个不错的选择。

### 比 `Bind mounts` 的优点

- 更容易备份和迁移数据
- 可以使用 `Docker CLI` 或者 `Docker API` 来操作
- 在 Linux 和 Windows 上均可运行
- 在多个容器间共享数据更安全
- 通过驱动，可以将数据存储到远端机器或者云上
- 新数据卷可以通过容器预先填充数据

### `-v` 还是 `--mount`

在 `Docker 17.06` 之后，独立的容器均可以使用 `-v (--volume)` 或者 `--mount` 来挂载数据卷。对于服务来说，只支持 `--mount` 。它们之间的最大区别就是： `-v` 将所有命令选项组合了起来，而 `--mount` 则是分开的。

- `-v` 或 `--volume`: 由三部分组成，由 `:` 分隔，同时每个部分必须以正确的顺序排列：
  - 命名卷的情况下，第一部分是卷的名称，在给定主机上是唯一的。对于匿名卷，第一部分是省略的
  - 第二部分是容器内的挂载的文件名或者文件夹的路径
  - 第三部分是可选的，以逗号分隔的选项列表。比如 `ro` ，默认是空的
- `--mount`: 由多个 `key-value` 对构成，以逗号分隔，不分顺序
  - `type`: 挂载的类型，可以是 `bind`, `volume`, `tmpfs`
  - `source`: 卷名称。可以简写成 `src`
  - `destination`: 容器内的路径。可以简写成 `dst` 或者 `target`
  - `readonly` 选项
  - `colume-opt` 选项，可以指定多次，由 `key-value` 组成

## `Bind mounts` 使用场景

- 在主机与容器间共享配置文件。这也是每个容器通过挂载主机的`/etc/resolv.conf`，默认提供`DNS解析`的方式。
- 开发环境下，与容器共享主机的源码

### 依然是 `-v` 还是 `--mount`

命令和 `Volume` 的一样。

对于 `-v` 来说：

- 第一部分是主机的文件或文件夹路径
- 第二部分一样
- 第三部分是可选的，以逗号分隔，选项有： `ro`, `consistent`, `delegated`, `cached`, `z` 和 `Z`

对于 `--mount` 来说：

- `type`: 与 `Volume` 一样
- `source`: 与 `Volume` 一样
- `destination`: 与 `Volume` 一样
- `readonly`: 与 `Volume` 一样
- `bind-propagation`: 可选的有： `rprivate`, `private`, `rshared`, `shared`, `rslave`, `slave` 。默认的是 `rprivate` 。
- `consistency`: 可选的有： `consistent`, `delegated`, `cached` 。此选项只针对 `Mac` 系统，其他系统会自动忽略
- 不支持 `z` 或 `Z`

对于 `Bind mounts` 来说，`-v` 和 `--mount` 是有区别的：

- 使用 `-v` ，绑定的主机的文件或者文件夹路径不存在，会自动创建，但是只会以`文件夹`形式被创建。
- 使用 `--mount` ，绑定的主机的文件或者文件夹路径不存在，不会自动创建，而是提示错误

`Bind propagation` 只在 `Linux` 主机才有效。指的是给定的`挂载卷`或`命名卷`中创建的挂载是否可以传播到该`挂载`（`mount`）的副本（`replicas`）。

### `tmpfs mounts` 使用场景

存储既不需要保存在本地主机或者在容器的数据，一般是基于安全考虑的敏感数据。
